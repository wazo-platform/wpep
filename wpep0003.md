| Key | Value |
| ---: | :--- |
| **Title** | Improve acl system scalibility |
| **Number** | 0003 |
| **Date** | 2019-12-10 |
| **Authors** | Mehdi Abaakouk <mabaakouk@wazo.io> |
| **Status** | proposed |

## Abstract

Redesign the way services checks token, alcs and tenant ownership

## Motivation

Currently Wazo-auth is heavily solicitated just for checking token validity, acls and tenant ownership relative to the supplied token.

### First issue, A service do three API calls to wazo-auth before it starts to handle a request.

The user get a call::

    GET /calls/{call_id} HTTP/1.1
    X-Auth-Token: {token}

Then wazo-calld check the token on wazo-auth and acl with::

    HEAD /token/{token}?scope=calld.calls.create

Wazo-auth compares the scope with the user acls.

Wazo-auth returns to wazo-calld::

    204 No content

Then Wazo-calld retrieves the tenant information on wazo-auth::

    GET /token/{token}

Wazo-auth returns the information::

    200 OK
    {
        "data": {
            "acls": [],
            "auth_id": "string",
            "expires_at": "string",
            "issued_at": "string",
            "metadata": {
                "tenant_uuid": "string"
            },
            "session_uuid": "string",
            "token": "string",
            "utc_expires_at": "string",
            "utc_issued_at": "string",
        }
    }

Then Wazo-calld retrieves the tenant tree on wazo-auth to check if the user is authorized to see the call::

    GET /tenants

Wazo-auth returns the information::

    200 Ok
    {
        "filtered": 0,
        "items": [
            {
                "name": "string",
                "uuid": "string"
            }
        ],
        "total": 0
    }


Wazo-calld now checks if the user `tenant_uuid` is part of the return list to grant access to the call.

Wazo-calld can now returns the call information to the user::

    200 OK
    {
        ...
    }


### Second issue, token creation and acl with variables

When we create a token, wazo-auth retrieves the policy for the user.

If the policy contains a variable (eg: {voicemail_id}), wazo-auth will do
additional and authenticated requests to wazo-confd (that will do the post check seen previously)

Due to the previous issue, this means token creation takes 4 wazo-auth API calls


## Proposition 1

### Remove the recurse=True and Wazo-Tenant header. Replace with tenant selection on token creation.

When a user creates a token, the user selects which tenant it wishes to work on with this tenant. That way the tenant hierarchy check can happen at token creation only for this token.

Pros:

* No more GET on `/tenants`

Cons:

* Some case requires that all resources are listed. That would require a solution to avoid doing a GET for each tenant. This happens most often with service to service queries where a service needs to know all trunks that are configured for example. Another case is `wazo-auth-cli user list` which would require a tenant name or uuid to be useful.
* Many tokens are required when managing multiple tenants instead of using the `Wazo-Tenant` header


## Proposition 2

### Stop using HEAD for the ACL, use GET with the scope and save the body for later

The GET on `/token/<token_uuid>` accepts an optional scope argument that can be used to check the ACL. Instead of checking the acl with HEAD and then fetching the body of the token the service could start with a GET with the scope and save the body of the token for futher processing if required.


## Proposition 3

### Set the tenant_uuid on the token

If the tenant_uuid of a token matches the tenant_uuid in `Wazo-Tenant` of if the header is ommited completly there's no need to GET `/tenants`.

If for example portal created a token with the tenant_uuid of the tenant it's managing instead of using the header than the tenant hierarchy would only be checked at token creation and all other requests could be made without querying /tenants

Pros:

* Avoid GET /tenants most of the time when specifying the tenant of the token
* Allow recurse=True to keep working for specific cases


## Proposition 4

### Use tokens that can be validated by the service handling the query without calling wazo-auth

Add details here :)


## Proposition 5

You're welcome
