| Key | Value |
| ---: | :--- |
| **Title** | wazo-confd Transactions & events |
| **Number** | 0007 |
| **Date** | 2021-10-18 |
| **Authors** | Sebastien Duthil <sduthil@wazo.io>, Pascal Cadotte Michaud <pcm@wazo.io> |
| **Status** | draft |

## Abstract

wazo-confd: Add a notification about a new configuration being applied and usable.

## Motivation

When changing configuration in wazo-confd, Wazo Platform needs some time to
apply the new configuration in other components, most notably for Asterisk to
reload its configuration files. When creating time-sensitive resources in
wazo-confd, e.g. meetings that can be used right away, the client needs to be
notified as soon as the resource is effectively created and usable. This WPEP
discusses mechanisms of such a notification.

## State of the art in Wazo Platform

Async API are currently used in Wazo Platform:

* wazo-provd provisioning plugin installation
  * Returns a code 201 with an "installation ID" that must be polled later to know the progress of installation
* wazo-plugind Wazo Platform plugin installation
  * Returns a code 200, and subsequently sends multiple events `plugin_install_progress`
  
## Rejected propositions

* Use polling like wazo-provd
  * Polling is inefficient and a waste of resources. Pushing is a better notification model.
* Make wazo-confd requests synchronous with resource usability
  * This would make many requests much longer, about a 10x factor in the best cases.

## Proposition

The following HTTP header can be added in wazo-confd responses:

```http
Wazo-Transaction-ID: 1cdb8d4b-54bf-4ae7-a37f-e221de67549f
```

If the transaction ID is absent or undefined, the client MUST NOT wait for a subsequent event.

If the transaction ID is defined, the client MAY wait for the subsequent event:

```js
{
  "name": "transaction_end",
  "data": {
    "id": "1cdb8d4b-54bf-4ae7-a37f-e221de67549f",
    "status": "success",  // or "failure", or any other relevant value
    "requester_uuid": "7eb32c9d-8e63-402c-b0db-155e37a52707",
  }
}
```

The `transaction_end` events notifies the client that the new resource(s) can be used without any further delay.

The transaction ID is created by the server, since the client cannot guarantee the uniqueness of any value.

To avoid spamming, a client requesting transactions should be able to subscribe to only transactions it has itself started, not transactions started by other clients.

## Migration considerations

The transaction ID is added in a new HTTP header that does not conflict with any
previous API.

## Example

Considering a client

* configured with user UUID `28732736-22ea-4e3f-8333-8e137184676a`
* connected to a Wazo Platform WebSocket

Request for the creation of a meeting:

```http
POST /users/me/meetings

{
  "name": "Meeting with Alice"
}
```

Response:

```http
201 Created
Wazo-Transaction-ID: 16c0d83d-4b96-4531-b4ec-4481c90f5f50

{
  "uuid": "729cc830-0c41-4a12-9c63-46a66afb06b9",
  "name": "Meeting with Alice",
  ...
}
```

After a short while, the client receives on its WebSocket:

```
{
  "name": "transaction_end",
  "data": {
    "id": "16c0d83d-4b96-4531-b4ec-4481c90f5f50",
    "status": "success",
    "requester_uuid": "28732736-22ea-4e3f-8333-8e137184676a",
  }
}
```
