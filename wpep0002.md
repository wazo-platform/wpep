| Key | Value |
| ---: | :--- |
| **Title** | Improve distributed capabilities |
| **Number** | 0002 |
| **Date** | 2019-10-21 |
| **Authors** | Frederic Lepied <flepied@wazo.io> |
| **Status** | proposed |

## Abstract

Redesign the way services find each other and their configurations.

## Motivation

To be able to cope with container deployments like Kubernetes, Swarm
or docker-compose as well as distributed deployments on VM or bare
metal, the startup sequences of the services need to be more dynamic
without anything being done at install time.

## Proposition

Use Consul to discover services and settings.

While the needed services are not started (nothing in Consul), the
service should wait for them to start and publish their information.

If a service needs a database, it should manage it at startup: create
it if it doesn't exist and do the modifications if a database schema
change is needed.

The setup of the services themselves like RabbitMQ in cluster mode,
load balancing database is out of scope of this proposition. What is
exposed by this proposition is only the URI of the service not the way
it has been deployed.

To summarize, nothing should be done by the packages or the Ansible
installer at install time that is deployment specific. For example, at
install time, we must not generate SSL certs, create or manipulate
databases or set any deployment specific parameter.

For non Consul aware services like Asterisk, Kamailio, RTPEngine or
PostgreSQL, we have 2 options. First one is to create a wrapper which
is interfacing with Consul to publish the state and get the needed
parameters. The second option is to write a plugin for the projects
that support it like Asterisk or Kamailio to interface with Consul.

### Details

#### Locating a Consul server

All the services, plugins and wrappers that are Consul aware must use
the `WAZO_CONSUL_HOST`, `WAZO_CONSUL_PORT` and `WAZO_CONSUL_SCHEME`
environment variables to find a Consul server to start their
initialization. If these environment variables are not available,
these variables can also be found in `/etc/wazo-platform/consul`. The
default values are the following if nothing is set:

* `WAZO_CONSUL_HOST`: consul
* `WAZO_CONSUL_PORT`: 8500
* `WAZO_CONSUL_SCHEME`: http

In systemd mode (VM or bare-metal), the systemd service file could have
a statement like this to source the variables:

```
EnvironmentFile=/etc/wazo-platform/consul
```

This file will be created by the Ansible installer to reflect the
location of the Consul server in systemd mode using the
`wazo_consul_host`, `wazo_consul_port` and `wazo_consul_scheme`
Ansible variables.

#### SSL certificates

The SSL certificates for the internal API can be stored in Consul and
each service can get them at startup. Following
https://www.consul.io/docs/connect/
